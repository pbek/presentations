name: Release PDFs

on:
    push:
        tags:
            - "v*"

jobs:
    create_release:
        name: "🗃️️ Create release"
        permissions:
            contents: write # for actions/create-release to create a release
        runs-on: ubuntu-latest
        outputs:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
        steps:
            - name: Create Release
              id: create_release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ github.ref }}
                  release_name: Release ${{ github.ref }}
                  draft: false
                  prerelease: false

    build_and_release:
        name: "🏗️ Build and release PDFs"
        permissions:
            contents: write # for actions/upload-release-asset to upload assets
        needs: create_release
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v5
            - name: ⚙️ Install Nix
              uses: cachix/install-nix-action@v31
              with:
                  nix_path: nixpkgs=channel:nixos-unstable
            - name: 🔧 Install devenv.sh
              run: nix profile add nixpkgs#devenv
            - name: 📃 Build PDFs
              run: devenv shell "just build-pdfs"
            - name: 🚀 Upload Release Assets
              run: |
                  for pdf in ./.build/*.pdf; do
                    if [ -f "$pdf" ]; then
                      baseName=$(basename "$pdf" .pdf)
                      echo "Uploading $baseName.pdf..."
                      gh release upload ${{ github.ref_name }} "$pdf" --clobber
                    fi
                  done
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
